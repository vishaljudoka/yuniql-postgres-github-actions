# =============================================================================
# Yuniql Database Migration Workflow
# =============================================================================
# Runs PostgreSQL migrations using Yuniql CLI.
# Trigger: Push to main (migrations path) or manual dispatch.
# =============================================================================

name: Database Migration

on:
  push:
    branches: [main]
    paths:
      - 'db/migrations/**'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug output'
        required: false
        default: 'false'
        type: boolean

env:
  YUNIQL_VERSION: '1.3.15'
  MIGRATIONS_PATH: 'db/migrations'

jobs:
  migrate:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            8.0.x

      - name: Install Yuniql CLI
        run: |
          dotnet tool install -g yuniql.cli --version "$YUNIQL_VERSION"
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Verify Yuniql
        run: yuniql version

      - name: Run Migrations
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          echo "=== Running Database Migrations ==="
          echo "Database: $DB_NAME"
          echo "Path: $MIGRATIONS_PATH"
          
          CONNECTION_STRING="Host=${DB_HOST};Port=5432;Database=${DB_NAME};Username=${DB_USER};Password=${DB_PASSWORD};SSL Mode=Require;Trust Server Certificate=true"

          # Build yuniql command
          YUNIQL_CMD="yuniql run \
            --platform postgresql \
            --connection-string \"$CONNECTION_STRING\" \
            --path \"$MIGRATIONS_PATH\" \
            --auto-create-db false"

          # Add debug flag if requested
          if [ "${{ inputs.debug }}" = "true" ]; then
            YUNIQL_CMD="$YUNIQL_CMD --debug"
          fi

          eval $YUNIQL_CMD

      - name: Migration Complete
        run: echo "Database migrations completed successfully!"
